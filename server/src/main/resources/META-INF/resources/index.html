<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Positizing â€¢ Positiveâ€‘Language API Demo</title>

    <!-- Quicksand 700 (bold) -->
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@700&display=swap" rel="stylesheet">

    <!-- Milligram for basic layout -->
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/milligram/1.4.1/milligram.min.css">

    <style>
        body        { max-width:800px; margin:3rem auto; }
        /* --- brand strip --- */
        .brandBar   { display:flex; align-items:center; gap:1rem;
            justify-content:center; margin-bottom:2rem; }
        .brandBar img       { width:100px; }
        .brandBar .brandTxt { font-family:'Quicksand', sans-serif;
            font-size:10rem; font-weight:700;
            color:#333; }
        /* --- demo area --- */
        textarea    { height:120px; }
        #resultCard { margin-top:2rem; }
        .negSpan    { background:#fff9c4; padding:2px 4px; border-radius:3px; }
        .suggestion { margin:0.4rem 0; padding:0.6rem; background:#f7f7f7;
            border-left:4px solid #64b5f6; display:flex; align-items:center; }
        .suggestion span { flex:1; }
        button.feedback { margin-left:0.5rem; cursor:pointer; }
        /* highlight selected votes */
        .feedback.selected { background-color: #64b5f6; color: white; }
    </style>
</head>

<body>
<!-- Brand strip with logo + wordmark -->
<div class="brandBar">
    <img src="img/positizing.png" alt="Positizing logo">
    <span class="brandTxt">POSITIZING</span>
    <img src="img/positizing.png" alt="Positizing logo">
</div>

<h3>Positize your speech!</h3>
<p>Enter a sentence (or two) below and click <em>Detect</em>.</p>

<!-- Text input for user prompt -->
<textarea id="input" placeholder="I donâ€™t think you should do that."></textarea>
<!-- Button to trigger API call -->
<button id="detectBtn" class="button">Detect</button>

<!-- Container for rendering suggestions -->
<div id="resultCard"></div>

<script>
    // ===== Session Initialization =====
    let token = localStorage.getItem('positizing_token');
    if (!token) {
        token = crypto.randomUUID();
        localStorage.setItem('positizing_token', token);
        console.debug('Generated new session token:', token);
    } else {
        console.debug('Loaded existing session token:', token);
    }

    const ua = navigator.userAgent;
    console.debug('User agent:', ua);

    // ===== DOM References =====
    const inputEl    = document.getElementById('input');
    const detectBtn  = document.getElementById('detectBtn');
    const resultCard = document.getElementById('resultCard');

    // Track per-suggestion votes: 1 = upvoted, -1 = downvoted, 0 = none
    const voteState = {};

    // Event Listeners
    detectBtn.addEventListener('click', runDetect);
    inputEl.addEventListener('keypress', e => {
        if (e.key === 'Enter') {
            e.preventDefault();
            runDetect();
        }
    });

    /**
     * Call API and render suggestions
     */
    async function runDetect() {
        const prompt = inputEl.value.trim();
        console.debug('runDetect() with prompt:', prompt);
        if (!prompt) return;
        resultCard.innerHTML = '<p>Loadingâ€¦</p>';

        const payload = { prompt, token, ua };
        console.debug('POST /api/rephrase', payload);

        let res;
        try {
            res = await fetch('/api/rephrase', {
                method: 'POST',
                headers: { 'Content-Type':'application/json' },
                body: JSON.stringify(payload)
            });
        } catch (err) {
            console.error('Network error:', err);
            resultCard.innerHTML = '<p>Network error. Try again.</p>';
            return;
        }

        if (!res.ok) {
            console.error('API error:', res.status, res.statusText);
            resultCard.innerHTML = `<p>Error ${res.status}: ${res.statusText}</p>`;
            return;
        }

        let data;
        try {
            data = await res.json();
        } catch (err) {
            console.error('Parsing error:', err);
            resultCard.innerHTML = '<p>Invalid response.</p>';
            return;
        }
        console.debug('API response:', data);

        let suggestions = [];
        if (Array.isArray(data)) suggestions = data;
        else if (data.suggestions) suggestions = data.suggestions;
        else if (data.response) suggestions = [data.response];
        console.debug('Suggestions to render:', suggestions);

        renderResults(prompt, suggestions);
    }

    /**
     * Render each suggestion with toggling vote buttons
     */
    function renderResults(prompt, suggestions) {
        resultCard.innerHTML = '';
        suggestions.forEach(text => {
            const div = document.createElement('div');
            div.className = 'suggestion';

            const span = document.createElement('span');
            span.textContent = text;
            div.appendChild(span);

            // Create buttons
            const upBtn = document.createElement('button');
            upBtn.className = 'feedback';
            upBtn.textContent = 'ðŸ‘';
            upBtn.title = 'Upvote';

            const downBtn = document.createElement('button');
            downBtn.className = 'feedback';
            downBtn.textContent = 'ðŸ‘Ž';
            downBtn.title = 'Downvote';

            // Initialize state
            updateButtonStyles(text, upBtn, downBtn);

            // Attach vote handlers
            upBtn.addEventListener('click', () => handleVote(prompt, text, 1, upBtn, downBtn));
            downBtn.addEventListener('click', () => handleVote(prompt, text, -1, upBtn, downBtn));

            div.appendChild(upBtn);
            div.appendChild(downBtn);
            resultCard.appendChild(div);
        });
    }

    /**
     * Toggle vote state and send update
     */
    function handleVote(prompt, suggestion, voteValue, upBtn, downBtn) {
        const current = voteState[suggestion] || 0;
        const newVote = current === voteValue ? 0 : voteValue;
        voteState[suggestion] = newVote;
        console.debug('Vote for', suggestion, '->', newVote);
        updateButtonStyles(suggestion, upBtn, downBtn);
        sendFeedback(prompt, suggestion, newVote);
    }

    /**
     * Reflect vote state in button styles
     */
    function updateButtonStyles(suggestion, upBtn, downBtn) {
        const state = voteState[suggestion] || 0;
        upBtn.classList.toggle('selected', state === 1);
        downBtn.classList.toggle('selected', state === -1);
    }

    /**
     * POST vote (or unvote) to server
     */
    async function sendFeedback(prompt, suggestion, vote) {
        const payload = { prompt, suggestion, vote, token, ua };
        console.debug('POST /cache/vote', payload);
        try {
            const res = await fetch('/cache/vote', {
                method: 'POST',
                headers: { 'Content-Type':'application/json' },
                body: JSON.stringify(payload)
            });
            console.debug('Vote response:', res.status);
        } catch (err) {
            console.error('Feedback error:', err);
        }
    }
</script>
</body>
</html>